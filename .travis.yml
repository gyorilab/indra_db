language: python
cache:
  directories:
    - $HOME/.cache/pip
python:
  - "3.5"
  - "3.6"
before_install:
  - sudo add-apt-repository --yes ppa:webupd8team/java
  - sudo apt-get update
  - echo debconf shared/accepted-oracle-license-v1-1 select true | sudo debconf-set-selections
  - echo debconf shared/accepted-oracle-license-v1-1 seen true | sudo debconf-set-selections
  - pip install numpy scipy sympy cython nose lxml matplotlib==1.5.0 pandas
  - sudo pip2 install numpy
install:
  # REACH
  - sudo apt-get install -y oracle-java8-installer || true
  - cd /var/lib/dpkg/info
  - sudo sed -i 's|JAVA_VERSION=8u171|JAVA_VERSION=8u181|' oracle-java8-installer.*
  - sudo sed -i 's|PARTNER_URL=http://download.oracle.com/otn-pub/java/jdk/8u171-b11/512cd62ec5174c3487ac17c61aaa89e8/|PARTNER_URL=http://download.oracle.com/otn-pub/java/jdk/8u181-b13/96a7b8442fe848ef90c96a2fad6ed6d1/|' oracle-java8-installer.*
  - sudo sed -i 's|SHA256SUM_TGZ="b6dd2837efaaec4109b36cfbb94a774db100029f98b0d78be68c27bec0275982"|SHA256SUM_TGZ="1845567095bfbfebd42ed0d09397939796d05456290fb20a83c476ba09f991d3"|' oracle-java8-installer.*
  - sudo sed -i 's|J_DIR=jdk1.8.0_171|J_DIR=jdk1.8.0_181|' oracle-java8-installer.*
  - sudo apt-get update
  - sudo apt-get install -y oracle-java8-installer
  - cd $TRAVIS_BUILD_DIR
  - sudo update-java-alternatives -s java-8-oracle
  - sudo apt-get install oracle-java8-set-default
  - export JAVA_HOME="/usr/lib/jvm/java-8-oracle/"
  - pip install git+https://github.com/kivy/pyjnius.git@1cbfef
  - wget http://sorger.med.harvard.edu/data/bachman/reach-82631d-biores-e9ee36.jar -nv
  - export REACHPATH=$TRAVIS_BUILD_DIR/reach-82631d-biores-e9ee36.jar
  # INDRA dependencies
  - pip install coverage python-coveralls boto3 sqlalchemy psycopg2-binary pgcopy nose-timer flask nltk reportlab
  - pip install git+https://github.com/bgyori/paths_graph.git@networkx2
  - pip install doctest-ignore-unicode
  - pip install git+https://github.com/sorgerlab/indra.git
  # INDRA-DB dependencies
  - pip install .[test]
  # DB Preassembly pickles
  - cd $TRAVIS_BUILD_DIR/indra_db/tests
  - curl https://s3.amazonaws.com/bigmech/indra-db/test_resources/db_pa_test_input_1M.pkl > db_pa_test_input_1M.pkl
  - curl https://s3.amazonaws.com/bigmech/indra-db/test_resources/test_ftp.zip > test_ftp.zip
  - unzip test_ftp.zip
  - pip install -U networkx>=2
  - pip list
before_script:
  # Enable plotting on fake display
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3
script:
  - export PYTHONPATH=$PYTHONPATH:$TRAVIS_BUILD_DIR
  - export SITEMAPPER_CACHE_PATH=$TRAVIS_BUILD_DIR/site_mapper_cache.pkl
  # Run standard unit tests
  - cd $TRAVIS_BUILD_DIR
  # doctests on Travis would otherwise fail
  - export NOSEATTR="!notravis";
  - if [[ $TRAVIS_PULL_REQUEST != "false" ]]; then
      export NOSEATTR="!nonpublic,$NOSEATTR";
    fi
  - if [[ $RUN_SLOW != "true" ]]; then
      export NOSEATTR="!slow,$NOSEATTR";
    fi
  - echo "NOSEATTR=" $NOSEATTR
  # Now run all INDRA_DB tests
  - nosetests indra_db -v -a $NOSEATTR
        --with-coverage --cover-inclusive --cover-package=indra
        --with-doctest --with-timer --timer-top-n 10
  - cd $TRAVIS_BUILD_DIR
  # Run code style report on diff
  - git remote set-branches --add origin master
  - git fetch
  - git diff origin/master | pycodestyle --diff > pep8.txt; cat pep8.txt;
after_success:
  - coveralls
