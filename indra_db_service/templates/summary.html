{% extends "idbr_template.html" %}

{% block scripts %}
  {{ super() }}
  <script src="https://unpkg.com/vue@3.0.11/dist/vue.global.js"></script>
  <style>
        #app { padding-top: 0; }
        #toc.sticky-top { top: 90px; }
        #database-statistics, #content-insights, #gene-mesh {
          scroll-margin-top: 110px;
        }
        .stats-card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            border-radius: 8px;
            background-color: #fff;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .stats-label {
            font-size: 1rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stats-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #3498db;
        }
    </style>
{% endblock %}


{% block body %}
  {{ super() }}
  <div id="app" class="container-fluid ">
      <div class="row">
        <!-- Left TOC -->
    <div class="col-sm-3 d-none d-sm-none d-md-block">
      <nav id="toc" data-toggle="toc" class="sticky-top">
        <ul class="nav navbar-nav">
          <li><a class="nav-link active" href="#database-statistics">Database Statistics</a></li>
          <li><a class="nav-link" href="#content-insights">Content Insights</a></li>
          <li>
            <a class="nav-link" href="#gene-mesh">Gene-Disease MeSH Distributions</a>
          </li>
        </ul>
      </nav>
    </div>
          <div class="col-12 col-md-9">

    <!-- 0. Top Statistics Cards -->
    <div class="row mb-5 mt-3" id="database-statistics">

        <div class="col-12">
         <h2 class="border-bottom pb-2 mb-4">Database Statistics</h2>
        </div>

        <div class="col-md-3">
            <div class="stats-card">
                <i class="fas fa-align-left stats-icon"></i>
                <div class="stats-number">{% raw %}{{ animated.unique_statement.toLocaleString() }}{% endraw %}</div>
                <div class="stats-label">Unique Statements</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="fas fa-file-alt stats-icon"></i>
                <div class="stats-number">{% raw %}{{ animated.abstract.toLocaleString() }}{% endraw %}</div>
                <div class="stats-label">Abstracts</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="fas fa-file-pdf stats-icon"></i>
                <div class="stats-number">{% raw %}{{ animated.fulltext.toLocaleString() }}{% endraw %}</div>
                <div class="stats-label">Full Texts</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <i class="fas fa-book stats-icon"></i>
                <div class="stats-number">{% raw %}{{ animated.title.toLocaleString() }}{% endraw %}</div>
                <div class="stats-label">Paper Titles</div>
            </div>
        </div>
    </div>

    <!-- 1. Database Content Section -->
    <div class="container-fluid" id="content-insights">

      <div class="row mb-4">
         <div class="col-12">
            <h2 class="border-bottom pb-2 mb-4">Content Insights</h2>
         </div>
      </div>

      <!-- Item 1: Statement Type -->
      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/stmt_type_dist.png') }}"
                 class="img-fluid zoomable" style="max-height: 400px; cursor: pointer;" alt="Statement Types" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
            <h5>Statement Type Distribution</h5>
            <p class="text-justify">
                The statement type distribution shows a diversity of statement relations across 45 distinct types (e.g. activation, phosphorylation).
            </p>
          </div>
      </div>

      <!-- Item 2: Belief Score -->
      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/belief_score_dist.png') }}"
                 class="img-fluid zoomable" style="max-height: 400px; cursor: pointer;" alt="Belief Scores" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
            <h5>Belief Score Distribution</h5>
            <p class="text-justify">
                Belief scores are computed using INDRA’s HybridScorer, which combines a data-driven CountsScorer with a prior-based SimpleScorer.
                For statements whose evidence sources were observed during training, the CountsScorer estimates reliability.
                Support for more specific statements is propagated to their corresponding generalized statements, increasing the belief scores of the latter.
            </p>
          </div>
      </div>

      <!-- Item 3: Grounding -->
      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/grounding_dist.png') }}"
                 class="img-fluid zoomable" style="max-height: 300px; cursor: pointer;" alt="Grounding Distribution" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
            <h5>Grounding Distribution</h5>
            <p class="text-justify">
                After collecting and assembling all sources, the resulting corpus indexed by the database contains a total of 47,956,726 unique INDRA Statements.
                Of these, nearly 65.2% referred to at least one ungrounded entity.
                While statements about protein complexes can involve more than two entities, the vast majority 98.3% involved exactly two entities.
            </p>
          </div>
      </div>

      <!-- Item 4: Paper Trends -->
      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/paper_trends.png') }}"
                 class="img-fluid zoomable" style="max-height: 300px; cursor: pointer;" alt="Paper Trends" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
            <h5>Paper Trends (Abstracts vs Fulltext)</h5>
            <p class="text-justify">
                A steady increase from year 1970 to 2024 exhibits a growing trend in the number of papers over time.
                The lower bar in 2025 reflects content availability through May 2025.
                Before 1970, starting 1780, there are 52,779 abstract and 226,925 full text records in the database.
            </p>
          </div>
      </div>

      <!-- Extra Items: Counts (Keep them vertical as requested, though no specific text provided in prompt for these) -->
      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/evidence_vs_stmt.png') }}"
                 class="img-fluid zoomable" style="max-height: 300px; cursor: pointer;" alt="Evidence vs Stmt" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
             <h5>Evidence vs Statement Count</h5>
             <p class="text-justify">The scatter plot shows a strong inverse relationship between the number of evidence and the number of statements on a log–log scale.
                 Most statements are supported by only a small number of evidence, while a very small number of statements aggregate a disproportionately large amount of evidence, forming a clear long-tailed distribution. </p>
          </div>
      </div>

      <div class="row mb-5 align-items-center">
          <div class="col-md-7 text-center">
            <img src="{{ url_for('static', filename='plots/pmid_vs_stmt.png') }}"
                 class="img-fluid zoomable" style="max-height: 300px; cursor: pointer;" alt="PMID vs Stmt" onclick="showImage(this)">
          </div>
          <div class="col-md-5">
             <h5>PMID vs Statement Count</h5>
             <p class="text-justify">The plot shows a strong inverse relationship between the number of unique PMIDs per statement and the number of statements on a log–log scale.
                 The distribution is highly skewed, with most statements supported by only a few PMIDs, while a small fraction of statements accumulate evidence from hundreds to tens of thousands of publications.</p>
          </div>
      </div>

    </div>


    <!-- 2. Gene Specific MeSH Terms Section -->
    <div class="row mb-5" id="gene-mesh">
        <div class="col-12">
            <h3 class="border-bottom pb-2 mb-4">Gene-Disease MeSH Distributions</h3>
        </div>
        {% for gene in ['EGFR', 'TP53', 'MAPT', 'SNCA', 'BRCA1', 'BRAF'] %}
        <div class="col-md-4 text-center mb-4">
            <img src="{{ url_for('static', filename='plots/mesh_dist_' + gene + '.png') }}"
                 class="img-fluid zoomable" style="cursor: pointer;" alt="{{ gene }} MeSH" onclick="showImage(this)">
        </div>
        {% endfor %}
        </div>
      </div>

  </div>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center bg-light">
          <img id="modalImage" src="" class="img-fluid" alt="Preview">
        </div>
      </div>
    </div>
  </div>

  <script>
    const app = Vue.createApp({
        data() {
            return {
                stats: { unique_statement: 0, abstract: 0, fulltext: 0, title: 0 },
                animated: { unique_statement: 0, abstract: 0, fulltext: 0, title: 0 }
            }
        },
        mounted() { this.fetchStats(); },
        methods: {
            async fetchStats() {
                try {
                    const response = await fetch("{{ url_for('serve_db_stats') }}");
                    const data = await response.json();
                    this.stats = data;
                    this.animateNumbers();
                } catch (error) { console.error("Failed to fetch stats:", error); }
            },
            animateNumbers() {
                const duration = 1500; const steps = 60; const interval = duration / steps;
                let currentStep = 0;
                const timer = setInterval(() => {
                    currentStep++;
                    const progress = currentStep / steps;
                    const ease = 1 - Math.pow(1 - progress, 3);
                    for (const key in this.stats) { this.animated[key] = Math.floor(this.stats[key] * ease); }
                    if (currentStep >= steps) { clearInterval(timer); this.animated = {...this.stats}; }
                }, interval);
            }
        }
    });
    app.mount('#app');

    function showImage(imgElement) {
        var modalImg = document.getElementById("modalImage");
        var modalTitle = document.getElementById("imageModalLabel");
        modalImg.src = imgElement.src;
        modalTitle.innerText = imgElement.alt || "Image Preview";
        $('#imageModal').modal('show');
    }
  </script>
{% endblock %}
